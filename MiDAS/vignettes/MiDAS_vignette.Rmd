---
title: "MiDAS Quick Start"
author: "Maciej MigdaÅ‚ & Christian Hammer & Dan Fu Ruan & others"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

devtools::load_all()
library("dplyr")
library("knitr")
library("kableExtra")
```

# Introduction
`MiDAS` package provide tools for working with HLA data generated by HLA 
inference tools for WGS data such as "HLA-HD". Main purpose of those tools is to
make it as easy as possible to import, transform and analyse HLA data. Moreover 
package also provides functionality to work with KIR haplotype data, including
integration with HLA alleles.

# Quick start

## Reading input data
Input for `MiDAS` includes an phenotypical observations data, HLA or KIR typing
data. `MiDAS` provides functions for reading HLA and KIR typing data, which will
check format correctnes and typings adherence with nomenclature. Phenotypical
observations can be read using function such as `read.table`, however it is
important to not convert characters to factors, so remeber to use 
`stringsAsFactors = FALSE` argument.

```{r loading_data}
coldata_file <- system.file("extdata", "MiDAS_tut_pheno.txt", package = "MiDAS")
coldata <- read.table(coldata_file, header = TRUE, stringsAsFactors = FALSE)

kable(coldata) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%", height = "200px")

# hla calls can be loaded using readHlaCalls function
hla_calls_file <- system.file("extdata", "MiDAS_tut_HLA.txt", package = "MiDAS")
hla_calls <- readHlaCalls(hla_calls_file)

kable(hla_calls) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%", height = "200px")
```

## Creating midas data sets
First step to analyse HLA data is to create a data set that will include all the 
information we will use for statistical modeling. For that `MiDAS` provides 
`prepareMiDAS` function. 

Important arguments are our typing inputs (`hla_calls`, `kir_calls`), phenotypic
observations (`coldata`). Finally we need to specify type analysis we will want 
to conduct using experiment argument. Here we will use `'hla_allele'` (check 
`?prepareMiDAS` for more details). 

```{r creating_midas_data_set}
midas <- prepareMiDAS(
  hla_calls = hla_calls,
  colData = coldata,
  experiment = "hla_alleles"
  )
```

## MiDAS object
MiDAS object contains our input data as well as it's tranformation to specified
experiment. This is an extention of `MultiAssayExperiment` and can be handled as
such. `MiDAS` provides some functions to interact with `MiDAS` objects,  check 
`?MiDAS-class` for a full list.

```{r midas_obj}
midas
```

## Association analysis
### Model definition
Before the actuall analysis can be run we still need to define model we would
like to use. We can use most of the statistical models available in R, such as
`lm`, `glm`, `coxme` etc. (technically they need to have a tidy method available).
`MiDAS` package than provides wraper function that will evaluate our model for
each HLA allele in our data. Let's see how it is done.

Here we will use a very simple formula `disease ~ term` where term is a variable
keeping HLA allele. This notation works also with interactions 
(`disease ~ lab_value:term`) and other appropiate operations.

`midas` has to be passed as a `data` argument to our statistical function, here
we are using `glm`.

```{r model definition}
# Logistic regression
object <- glm(disease ~ term, data = midas, family = binomial(link = "logit"))
```

### Running analysis
To run our analysis we will use `runMiDAS` function. This function offers 
multiple analysis scenarios which can be tuned using `conditional` and 
`omnibus` arguments. It can also pre-filter input data based on frequency,
check `?runMiDAS` to learn more.

```{r association_analysis}
results <-
  runMiDAS(
    object = object,
    experiment = "hla_alleles",
    conditional = FALSE,
    omnibus = FALSE
    )

kableResults(results)
```
